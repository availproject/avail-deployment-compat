FROM rust:1.70.0 AS chef
# We only pay the installation cost once, 
# it will be cached from the second build onwards
RUN cargo install cargo-chef --version 0.1.62
WORKDIR app

FROM chef AS planner

ARG LC_BRANCH=doesnt_exist
RUN git clone --depth 1 -b ${LC_BRANCH} https://github.com/availproject/avail-light.git && cd avail-light
WORKDIR /app/avail-light
RUN cargo chef prepare --recipe-path /app/avail-light/recipe.json

FROM chef AS builder
WORKDIR app
COPY --from=planner /app/avail-light/recipe.json recipe.json
RUN apt-get update && \
	apt-get install -y libssl1.1 gettext-base wait-for-it ca-certificates clang protobuf-compiler && \
	rm -rf /var/lib/apt/lists 

ARG LC_BRANCH=doesnt_exist
# Build application
RUN rm -rf avail-light && git clone --depth 1 -b ${LC_BRANCH} https://github.com/availproject/avail-light.git
RUN cp recipe.json /app/avail-light
# Build dependencies - this is the caching Docker layer!
RUN cd avail-light && cargo chef cook --release --recipe-path /app/avail-light
# This will utilize caching and check if rebuild is needed - if the branch has changed, so will this response
ADD https://api.github.com/repos/availproject/avail-light/commits/${LC_BRANCH} last_commit.json
RUN cd avail-light && git fetch origin && git reset --hard ${LC_BRANCH} && git pull
RUN cd avail-light && cargo build --release
RUN cd avail-light/target/release && pwd

# We do not need the Rust toolchain to run the binary!
FROM debian:bullseye-slim AS runtime
WORKDIR app
RUN apt-get update && \
	apt-get install -y libssl1.1 gettext-base wait-for-it ca-certificates clang
COPY ./resources/* /app/avail-light/
ENV \
	HTTP_SERVER_HOST="127.0.0.1" \
	HTTP_SERVER_PORT=7000 \
	IPFS_SEED=1 \
	IPFS_PORT=37000 \
	IPFS_PATH="avail_ipfs_store" \
	FULL_NODE_WS="ws://host.docker.internal:9944" \
	APP_ID=0 \
	CONFIDENCE=92.0 \
	AVAIL_PATH="avail_path" \
	BOOTSTRAPS="[[\"12D3KooWSDaGuV1ewhyAEYsA6rk52hJyeN16hDE6bNgyRt62x7ie\",\"/ip4/127.0.0.1/udp/5369/quic-v1\"]]" \
	LOG_LEVEL="INFO" \
	PARALLEL_TASKS=8 \
	IPFS_SEED_RANDOM=false \
	DISABLE_RPC=false \
	BLOCK_PROCESSING_DELAY=0 \
	DISABLE_PROOF_VERIFICATION=false \
	BLOCK_MATRIX_PARTITION="\"None\"" \
	QUERY_PROOF_RPC_PARALLEL_TASKS=10

WORKDIR /app/avail-light
COPY --from=builder /app/app/avail-light/target/release/avail-light /app/avail-light
ENTRYPOINT ["/app/avail-light/start.sh"]